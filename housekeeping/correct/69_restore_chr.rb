arr = %w(400008468
400110528
402002485
402003163
402003173
402004074
402004095
402004096
409000541
409000542
410005195
840010115
840011060
840011085
840011096
840011097
840011100
840011101
840011103
840013358
840014457
840014468
840014539
840014540
840014541
840015423
840015425
840015429
840015432
840015436
840015437
840015440
840015448
840015449
840015451
840015454
840015458
840015460
840015461
840015462
840015463
840015464
840015467
840015468
840015469
840015474
840015478
840015479
840015483
840015486
840015497
840015499
840015500
840015501
840015602
840016115
840016547
840016559
840016576
840016603
840016655
840016658
840016837
840017220
840027154
850602657
850602660
850604834
850605921
850605992
850607425
850615224
850616257
850616462
850616463
850616464
850616465
850616613
850616614
850616615
850616616
850616617
850616618
850616619
850616636
850616637
850616648
850616795
850616796
850616797
850616798
850616799
850616800
850616801
850616802
850616806
850616807
850616808
850616809
850616810
850616811
850616812
850616813
850616814
850616818
850616819
850616820
850616821
850616822
850616823
850616827
850616828
850616829
850616830
850616831
850616843
850616844
850616845
850616990
850616991
850616992
850616993
850617415
850617416
850617417
850617418
850617568
850617569
850617580
850617581
850617582
850617583
850621159
850621160
850621161
850621321
850621322
850621323
850621484
850621485
850621486
850621487
850621488
850622950
850622951
850623102
850623106
850623107
850623264
850623265
850623266
850623267
850623268
850623269
850623270
850623271
850623272
850623273
850623274
850623275
850631576
850650839
850651804
850652895
850655145
850670575
850696066
850698664
850728907
850733757
850733758
850734157
850734207
850734652
850736117
850744043
850744174
850744176
850744280
850744320
850744321
850744322
850744323
850744581
850744582
850745408
850746153
850748071
850748076
850748202
850748426
850748563
850748995
850749906
850750574
850750575
850750576
850750578
850750579
850752305
850752468
850752790
850752993
850752994
850752996
850753585
850754733
850754973
850760113
850760821
850760975
850760976
850760977
850762649
850762657
850767257
850767258
850767544
850767545
850767546
850767547
850767548
850767549
850767550
850767705
850767706
850768684
850769852
850773635
850774502
850774509
850776861
850777617
850778757
850779669
850779756
850780073
850781138
850791344
850792167
850792663
850793445
850794553
850801277
850802936
850803577
850815612
1001112326)

person_subst = {
    40201094 => 30005109,
    40203339 => 40220521,
    40206438 => 30031925,
    40209898 => 30026052,
    40212201 => 40212212,
    41015072 => 30032590,
    41015178 => 30019303,
    41015220 => 40203220,
    41015382 => 30031926,
    41015432 => 30000111,
    41015451 => 30101802,
    41017452 => 40217024,
    41017487 => 30026052,
    41017795 => 85015,
    41017867 => 40201944,
    41018139 => 30098750,
    41018179 => 30106720,
    41019834 => 40214311,
    50033473 => 30042139,
    50033816 => 30043919,
    50036961 => 41008842,
    50038970 => 41015397,
    50039294 => 30098750,
    50039389 => 30013374,
    50039668 => 30047704,
    50039671 => 30084543,
    50039672 => 30031925}


def search_versions(s)
    s.versions.each do |v|
        so = v.reify
        so.marc.load_source false

        found = false
        the_dude = {}
        so.marc.each_by_tag("700") do |t|
            t.fetch_all_by_tag("4").each do |tn|
      
              next if !(tn && tn.content)
              if tn.content == "chr"
                found = true
                name = t.fetch_first_by_tag("a").content
                id = t.fetch_first_by_tag("0").content
                #puts "#{s.id}\t#{name}\t#{id}"
                the_dude = {id: id.to_i, name: name}
                return the_dude
              end
      
            end
      
        end
    end
    return nil
end

arr.each do |item|
    begin
        s = Source.find(item)
    rescue ActiveRecord::RecordNotFound
        puts "#{item} was deleted"
        next
    end

    the_dude = search_versions(s)

    search_id = person_subst.keys.include?(the_dude[:id]) ? person_subst[the_dude[:id]] : the_dude[:id]
    more_found = false

    s.marc.load_source true
    s.marc.each_by_tag("700") do |t|
        t.fetch_all_by_tag("0").each do |tid|

            if tid.content.to_i == search_id
                
                t4 = t.fetch_first_by_tag("4")
                t4.content = "chr"

                more_found = true
            end
        end
    end

    puts "OPS #{the_dude[:id]} #{search_id} src #{s.id}" if !more_found

    s.save
end