
#gem "string-similarity"
#gem "rest-client"

NAMESPACE={'marc' => "http://www.loc.gov/MARC21/slim", 'srw' => "http://www.loc.gov/zing/srw/", 'diag' => "http://www.loc.gov/zing/srw/diagnostic/", 'ucp' => "http://www.loc.gov/zing/srw/update/"}

bsb2holding = {"bsb00096578"=>[320115], "bsb00094285"=>[51057546], "bsb00085036"=>[325099], "bsb00081510"=>[327483], "bsb00081509"=>[327475], "bsb00071879"=>[327462], "bsb00081511"=>[327430], "bsb00081508"=>[327418], "bsb00081507"=>[327406], "bsb00082305"=>[51014747], "bsb00082649"=>[51014748], "bsb00093269"=>[51003733], "bsb00082700"=>[326501], "bsb00083812"=>[51005847], "bsb00082208"=>[326150], "bsb00082207"=>[326116], "bsb00086296"=>[51005759], "bsb00081816"=>[51007832], "bsb00081815"=>[51007826], "bsb00081884"=>[325724], "bsb00073470"=>[325682], "bsb00073473"=>[325622], "bsb00071884"=>[325505], "bsb00073472"=>[325470], "bsb00078112"=>[325425], "bsb00073471"=>[325416], "bsb00078547"=>[325364], "bsb00085260"=>[329318], "bsb00078546"=>[325145], "bsb00077795"=>[325051], "bsb00086008"=>[324960], "bsb00077421"=>[51005185], "bsb00074204"=>[324947], "bsb00071813"=>[324906], "bsb00071812"=>[324899], "bsb00071815"=>[324831], "bsb00071814"=>[324822], "bsb00077794"=>[324790], "bsb00071811"=>[324761], "bsb00077793"=>[324740], "bsb00077792"=>[324643], "bsb00071980"=>[324524], "bsb00071840"=>[324496], "bsb00071839"=>[324493], "bsb00074352"=>[324449], "bsb00071869"=>[324411], "bsb00071838"=>[324301], "bsb00073085"=>[324239], "bsb00076016"=>[324202], "bsb00086007"=>[324163], "bsb00073908"=>[51008474], "bsb00072954"=>[51002463], "bsb00072039"=>[324079], "bsb00080451"=>[324003], "bsb00072044"=>[324003], "bsb00078789"=>[323964], "bsb00072043"=>[329003], "bsb00080450"=>[323900], "bsb00072000"=>[323850], "bsb00080458"=>[323787], "bsb00074221"=>[323750], "bsb00074756"=>[323607], "bsb00074758"=>[320211], "bsb00074058"=>[323473], "bsb00074757"=>[323458], "bsb00083898"=>[323455], "bsb00010006"=>[323441], "bsb00086031"=>[51002697], "bsb00075263"=>[323393], "bsb00074754"=>[323376], "bsb00078279"=>[323348], "bsb00075262"=>[323332], "bsb00086030"=>[51032206], "bsb00074060"=>[323286], "bsb00077746"=>[323266], "bsb00075350"=>[323252], "bsb00086029"=>[323214], "bsb00086037"=>[329667], "bsb00071889"=>[323190], "bsb00074752"=>[323169], "bsb00075346"=>[323154], "bsb00072990"=>[329668], "bsb00066223"=>[323065], "bsb00087012"=>[323005], "bsb00075341"=>[322983], "bsb00084716"=>[322929], "bsb00072042"=>[329580], "bsb00075255"=>[322922], "bsb00071888"=>[322887], "bsb00084128"=>[322867], "bsb00083820"=>[322849], "bsb00071973"=>[322792], "bsb00078928"=>[51015814], "bsb00072003"=>[328439], "bsb00072031"=>[329337], "bsb00084735"=>[322752], "bsb00072030"=>[322745], "bsb00075257"=>[322735], "bsb00084137"=>[322729], "bsb00084129"=>[322723], "bsb00073090"=>[322696], "bsb00072002"=>[322625], "bsb00072001"=>[322620], "bsb00080525"=>[322577], "bsb00073082"=>[322570], "bsb00084673"=>[322484], "bsb00085259"=>[329167], "bsb00081002"=>[322470], "bsb00081001"=>[322468], "bsb00085258"=>[329166], "bsb00080512"=>[329158], "bsb00073089"=>[322435], "bsb00075420"=>[322369], "bsb00080492"=>[322356], "bsb00080516"=>[329156], "bsb00084749"=>[322335], "bsb00084750"=>[322333], "bsb00071975"=>[322327], "bsb00078818"=>[329151], "bsb00086124"=>[322314], "bsb00087016"=>[322197], "bsb00072032"=>[322170], "bsb00083381"=>[322117], "bsb00071984"=>[322114], "bsb00071986"=>[322050], "bsb00071985"=>[322073], "bsb00080523"=>[328711], "bsb00071881"=>[322007], "bsb00083300"=>[321978], "bsb00081874"=>[51033631], "bsb00081873"=>[51033630], "bsb00071785"=>[321926], "bsb00078343"=>[321918], "bsb00074351"=>[321866], "bsb00071842"=>[321862], "bsb00071865"=>[321840], "bsb00071864"=>[321819], "bsb00071863"=>[321798], "bsb00071862"=>[321777], "bsb00071944"=>[321761], "bsb00071861"=>[321741], "bsb00071997"=>[321727], "bsb00071882"=>[321708], "bsb00075335"=>[321703], "bsb00071841"=>[321631], "bsb00080493"=>[321606], "bsb00071885"=>[321600], "bsb00074124"=>[321580], "bsb00071946"=>[321523], "bsb00073086"=>[321453], "bsb00071788"=>[321438], "bsb00071787"=>[321417], "bsb00071983"=>[321400], "bsb00071786"=>[321382], "bsb00084828"=>[321349], "bsb00071947"=>[321337], "bsb00071994"=>[321317], "bsb00083363"=>[321298], "bsb00084830"=>[321271], "bsb00071907"=>[321265], "bsb00073484"=>[321215], "bsb00075020"=>[321202], "bsb00080886"=>[321196], "bsb00071974"=>[321188], "bsb00071945"=>[321173], "bsb00077377"=>[321139], "bsb00075412"=>[321127], "bsb00081868"=>[51022333], "bsb00085716"=>[321084], "bsb00080885"=>[321062], "bsb00085715"=>[321036], "bsb00074202"=>[320877], "bsb00071949"=>[320859], "bsb00071948"=>[320852], "bsb00075014"=>[320846], "bsb00086011"=>[320822], "bsb00086010"=>[320818], "bsb00079568"=>[320780], "bsb00079567"=>[320775], "bsb00080884"=>[320749], "bsb00074201"=>[320705], "bsb00074200"=>[320691], "bsb00074199"=>[320676], "bsb00084679"=>[320644], "bsb00071851"=>[320640], "bsb00079564"=>[51007340], "bsb00079563"=>[320601], "bsb00071901"=>[320594], "bsb00079562"=>[320574], "bsb00081878"=>[51020864], "bsb00072628"=>[320548], "bsb00074198"=>[320532], "bsb00079561"=>[320523], "bsb00071845"=>[51003722], "bsb00071844"=>[320512], "bsb00072625"=>[320485], "bsb00072624"=>[320469], "bsb00084680"=>[320453], "bsb00071850"=>[320386], "bsb00071849"=>[320374], "bsb00071848"=>[51003647], "bsb00071846"=>[51003729], "bsb00072036"=>[320249], "bsb00082119"=>[320237], "bsb00074426"=>[320229], "bsb00073614"=>[319194], "bsb00086205"=>[319340], "bsb00082622"=>[51049153], "bsb00075662"=>[377], "bsb00083912"=>[51021763], "bsb00074059"=>[327658], "bsb00074203"=>[327638], "bsb00071972"=>[327625], "bsb00071971"=>[51044235], "bsb00071970"=>[51044146], "bsb00072027"=>[318781], "bsb00087014"=>[268539], "bsb00087013"=>[268531], "bsb00094270"=>[268274], "bsb00075334"=>[268268], "bsb00089781"=>[269446], "bsb00090327"=>[268322], "bsb00094053"=>[268811], "bsb00074771"=>[268553], "bsb00084904"=>[260953], "bsb00075249"=>[263144], "bsb00075248"=>[263131], "bsb00075247"=>[263119], "bsb00080471"=>[263110], "bsb00075507"=>[263041], "bsb00073483"=>[263018], "bsb00089607"=>[263016], "bsb00075241"=>[263008], "bsb00073482"=>[262995], "bsb00089606"=>[262989], "bsb00078930"=>[51038954], "bsb00094076"=>[262976], "bsb00085256"=>[262966], "bsb00083819"=>[260908], "bsb00084952"=>[262213], "bsb00084954"=>[262209], "bsb00084951"=>[262208], "bsb00084949"=>[262188], "bsb00093846"=>[280348], "bsb00094082"=>[261299], "bsb00032625"=>[261296], "bsb00080557"=>[260726], "bsb00094277"=>[261281], "bsb00094276"=>[261280], "bsb00050860"=>[266544], "bsb00079634"=>[261227], "bsb00081894"=>[261209], "bsb00093444"=>[51059819], "bsb00093443"=>[263750], "bsb00071866"=>[263725], "bsb00087006"=>[263721], "bsb00094095"=>[263693], "bsb00071874"=>[263686], "bsb00071933"=>[263680], "bsb00073119"=>[263671], "bsb00073520"=>[263663], "bsb00073118"=>[263653], "bsb00094673"=>[51002428], "bsb00088225"=>[263454], "bsb00080887"=>[260722], "bsb00052276"=>[254870], "bsb00078280"=>[51008059], "bsb00084955"=>[260469], "bsb00071897"=>[257075], "bsb00084142"=>[257052], "bsb00084144"=>[257049], "bsb00084134"=>[257043], "bsb00072070"=>[257035], "bsb00084141"=>[257031], "bsb00072069"=>[257020], "bsb00084133"=>[329338], "bsb00094016"=>[256457], "bsb00054076"=>[256449], "bsb00071887"=>[256322], "bsb00072040"=>[51042033], "bsb00087760"=>[256273], "bsb00065876"=>[256264], "bsb00076017"=>[256231], "bsb00076018"=>[256230], "bsb00076019"=>[256210], "bsb00076020"=>[256119], "bsb00083352"=>[256046], "bsb00083351"=>[256044], "bsb00103285"=>[255886], "bsb00090654"=>[255878], "bsb00061738"=>[255822], "bsb00093755"=>[255434], "bsb00092397"=>[255418], "bsb00092399"=>[255395], "bsb00075250"=>[255320], "bsb00080475"=>[255318], "bsb00080459"=>[255225], "bsb00050404"=>[255207], "bsb00084130"=>[255126], "bsb00074119"=>[255015], "bsb00074118"=>[254993], "bsb00074117"=>[254960], "bsb00080510"=>[254950], "bsb00074716"=>[254929], "bsb00094019"=>[252149], "bsb00094017"=>[252081], "bsb00003637"=>[252022], "bsb00003638"=>[252018], "bsb00087003"=>[250560], "bsb00071938"=>[250550], "bsb00071937"=>[250534], "bsb00090898"=>[249597], "bsb00072068"=>[251729], "bsb00087015"=>[251250], "bsb00007322"=>[251172], "bsb00086779"=>[283933], "bsb00087592"=>[247510], "bsb00094189"=>[247331], "bsb00078110"=>[247330], "bsb00090356"=>[247326], "bsb00078153"=>[247325], "bsb00078111"=>[247324], "bsb00092021"=>[247322], "bsb00092339"=>[247320], "bsb00089609"=>[247319], "bsb00072076"=>[246723], "bsb00091970"=>[246656], "bsb00072075"=>[246603], "bsb00084742"=>[246585], "bsb00071883"=>[246578], "bsb00080883"=>[246568], "bsb00089780"=>[246537], "bsb00075344"=>[243899], "bsb00075338"=>[243898], "bsb00071957"=>[243895], "bsb00072072"=>[221963], "bsb00084724"=>[221957], "bsb00083515"=>[221940], "bsb00094151"=>[238147], "bsb00078109"=>[238136], "bsb00078108"=>[238124], "bsb00084933"=>[311186], "bsb00077229"=>[237934], "bsb00043647"=>[237927], "bsb00077228"=>[237920], "bsb00084903"=>[51006570], "bsb00077225"=>[237893], "bsb00094209"=>[237843], "bsb00080489"=>[237782], "bsb00086998"=>[221936], "bsb00093565"=>[223513], "bsb00091203"=>[223498], "bsb00093769"=>[223485], "bsb00095122"=>[236595], "bsb00087007"=>[235811], "bsb00092603"=>[235493], "bsb00094390"=>[51049029], "bsb00083813"=>[235479], "bsb00086012"=>[235465], "bsb00094146"=>[223302], "bsb00094187"=>[223299], "bsb00073110"=>[233642], "bsb00061775"=>[311077], "bsb00074414"=>[233536], "bsb00082623"=>[233530], "bsb00063837"=>[311061], "bsb00087018"=>[232750], "bsb00087017"=>[232741], "bsb00094985"=>[232426], "bsb00094997"=>[232405], "bsb00094978"=>[232354], "bsb00094110"=>[232171], "bsb00094196"=>[51002742], "bsb00094111"=>[232166], "bsb00087852"=>[231243], "bsb00094385"=>[231115], "bsb00084889"=>[230876], "bsb00071698"=>[230873], "bsb00092006"=>[230360], "bsb00094081"=>[230353], "bsb00093440"=>[51039129], "bsb00083379"=>[228450], "bsb00083823"=>[228438], "bsb00091603"=>[228323], "bsb00063841"=>[228182], "bsb00092744"=>[227586], "bsb00094164"=>[227529], "bsb00091037"=>[227544], "bsb00059253"=>[227430], "bsb00086781"=>[227409], "bsb00094161"=>[227354], "bsb00078787"=>[227238], "bsb00093036"=>[227080], "bsb00092004"=>[226313], "bsb00094102"=>[226253], "bsb00078107"=>[226248], "bsb00091742"=>[226168], "bsb00094280"=>[226083], "bsb00055095"=>[304877], "bsb00094099"=>[211236], "bsb00093756"=>[211204], "bsb00083361"=>[211163], "bsb00088224"=>[211116], "bsb00087008"=>[211109], "bsb00094022"=>[211101], "bsb00071906"=>[221372], "bsb00080892"=>[221359], "bsb00071905"=>[221349], "bsb00080891"=>[221340], "bsb00084718"=>[221330], "bsb00080890"=>[221322], "bsb00080889"=>[221304], "bsb00071904"=>[221293], "bsb00094119"=>[221233], "bsb00083824"=>[221220], "bsb00080479"=>[220401], "bsb00094195"=>[220363], "bsb00075419"=>[220264], "bsb00082199"=>[220045], "bsb00094105"=>[209574], "bsb00094107"=>[209573], "bsb00094106"=>[209571], "bsb00094104"=>[209569], "bsb00039076"=>[219758], "bsb00071880"=>[219609], "bsb00072033"=>[219580], "bsb00080893"=>[219535], "bsb00071995"=>[219516], "bsb00074425"=>[219461], "bsb00005464"=>[319563], "bsb00094346"=>[51015331], "bsb00094348"=>[51015332], "bsb00094357"=>[51050066], "bsb00092490"=>[213757], "bsb00083498"=>[213394], "bsb00083499"=>[213388], "bsb00088760"=>[213387], "bsb00094075"=>[213381], "bsb00094074"=>[213365], "bsb00092333"=>[213107], "bsb00075411"=>[213019], "bsb00094144"=>[212841], "bsb00071835"=>[212821], "bsb00089439"=>[212814], "bsb00094219"=>[212811], "bsb00092297"=>[212804], "bsb00093766"=>[212800], "bsb00071940"=>[212795], "bsb00094145"=>[212791], "bsb00094143"=>[212788], "bsb00094142"=>[212787], "bsb00094034"=>[208245], "bsb00094136"=>[189617], "bsb00082118"=>[189601], "bsb00082117"=>[189589], "bsb00079630"=>[189551], "bsb00094137"=>[189547], "bsb00073116"=>[189501], "bsb00094013"=>[189485], "bsb00072014"=>[189481], "bsb00072013"=>[189466], "bsb00083356"=>[189307], "bsb00094097"=>[189290], "bsb00072078"=>[189265], "bsb00073106"=>[189245, 189247], "bsb00086391"=>[189166], "bsb00087184"=>[189125], "bsb00085252"=>[189069], "bsb00085251"=>[189021], "bsb00085250"=>[188967], "bsb00085249"=>[188915], "bsb00085248"=>[188860], "bsb00093770"=>[188706], "bsb00082631"=>[188652], "bsb00090978"=>[188587], "bsb00055813"=>[188549], "bsb00065205"=>[188526], "bsb00031714"=>[188523], "bsb00087010"=>[188520], "bsb00083825"=>[188514], "bsb00080474"=>[206086], "bsb00080518"=>[206086], "bsb00086870"=>[206079], "bsb00086869"=>[206070], "bsb00084725"=>[206063], "bsb00086868"=>[206058], "bsb00080524"=>[51056027], "bsb00072071"=>[206044], "bsb00080478"=>[205896], "bsb00092770"=>[205722], "bsb00078931"=>[205704], "bsb00078936"=>[205610], "bsb00078933"=>[205518], "bsb00078932"=>[205489], "bsb00092298"=>[205100], "bsb00075414"=>[205096], "bsb00084717"=>[205088], "bsb00080888"=>[205084], "bsb00085253"=>[204962], "bsb00071867"=>[204952], "bsb00055814"=>[204933], "bsb00074766"=>[204868], "bsb00083497"=>[204644], "bsb00088516"=>[186677], "bsb00094141"=>[196051], "bsb00089079"=>[51006748], "bsb00075343"=>[195551], "bsb00094140"=>[194988], "bsb00074433"=>[193979], "bsb00074432"=>[193976], "bsb00084826"=>[193973], "bsb00084825"=>[193961], "bsb00104415"=>[192450], "bsb00094050"=>[192418], "bsb00094049"=>[192413], "bsb00094048"=>[192408], "bsb00094047"=>[192403], "bsb00019317"=>[319235], "bsb00019324"=>[319234], "bsb00086806"=>[192175], "bsb00086807"=>[192171], "bsb00073076"=>[190530], "bsb00087719"=>[190518], "bsb00088762"=>[190010], "bsb00072010"=>[185753], "bsb00089369"=>[185842], "bsb00092624"=>[186449], "bsb00084748"=>[186191], "bsb00075340"=>[186177], "bsb00091609"=>[186166], "bsb00085883"=>[185768], "bsb00080556"=>[182947], "bsb00083364"=>[182940], "bsb00084721"=>[182933], "bsb00071903"=>[182924], "bsb00087020"=>[185639], "bsb00090341"=>[185625], "bsb00090339"=>[185625], "bsb00047078"=>[184986], "bsb00083818"=>[184975], "bsb00083817"=>[184971], "bsb00084741"=>[184393], "bsb00090183"=>[184360], "bsb00094213"=>[183993], "bsb00094212"=>[183985], "bsb00094211"=>[183976], "bsb00083507"=>[182719], "bsb00064541"=>[183892], "bsb00083506"=>[182703], "bsb00092739"=>[182690], "bsb00085999"=>[182682], "bsb00094681"=>[302626], "bsb00081233"=>[283538], "bsb00094152"=>[182548], "bsb00086506"=>[182506], "bsb00083829"=>[151834], "bsb00086867"=>[151560], "bsb00090641"=>[162819], "bsb00084136"=>[162186], "bsb00080486"=>[162186], "bsb00075251"=>[162181], "bsb00090982"=>[162129], "bsb00087000"=>[161919], "bsb00077420"=>[320980], "bsb00077419"=>[320979], "bsb00081882"=>[161434], "bsb00078782"=>[51039186], "bsb00094041"=>[160674], "bsb00073077"=>[160562], "bsb00093267"=>[51007724], "bsb00080491"=>[157319], "bsb00080488"=>[157309], "bsb00083828"=>[149619], "bsb00091375"=>[316090], "bsb00090983"=>[306989], "bsb00090897"=>[302467], "bsb00084740"=>[51045572], "bsb00078927"=>[51036895], "bsb00078925"=>[51041797], "bsb00092955"=>[51003655], "bsb00087221"=>[51018055], "bsb00092954"=>[51023575], "bsb00094356"=>[315960], "bsb00094295"=>[51021708], "bsb00093469"=>[51052419], "bsb00089980"=>[51002763], "bsb00094080"=>[51039078], "bsb00063826"=>[315383], "bsb00092947"=>[51044689], "bsb00082713"=>[301009], "bsb00043293"=>[237, 125767], "bsb00064007"=>[282610], "bsb00094680"=>[282613], "bsb00094656"=>[300308], "bsb00092334"=>[319046], "bsb00052434"=>[309717], "bsb00076190"=>[51007563], "bsb00086014"=>[318997], "bsb00084829"=>[51023519], "bsb00073120"=>[319294], "bsb00084892"=>[297197], "bsb00074767"=>[297152], "bsb00093446"=>[51047954], "bsb00080483"=>[63455], "bsb00094771"=>[51033532], "bsb00081235"=>[294850], "bsb00077220"=>[294331], "bsb00080473"=>[54820], "bsb00063834"=>[271438], "bsb00103340"=>[44386], "bsb00086398"=>[51007993], "bsb00086495"=>[328914], "bsb00087090"=>[328644], "bsb00094138"=>[271427], "bsb00080511"=>[51006330], "bsb00010087"=>[289624], "bsb00093845"=>[51007691], "bsb00086121"=>[51058926], "bsb00089368"=>[17823], "bsb00094221"=>[284304], "bsb00094682"=>[284531], "bsb00007110"=>[284333], "bsb00063828"=>[272204], "bsb00063831"=>[275056], "bsb00091187"=>[274839], "bsb00094046"=>[273758], "bsb00092550"=>[51027645], "bsb00094045"=>[273757], "bsb00094183"=>[273705], "bsb00094246"=>[313183], "bsb00094354"=>[273196], "bsb00093866"=>[313080], "bsb00084950"=>[285463], "bsb00094225"=>[286263], "bsb00090642"=>[286258], "bsb00094657"=>[51037730], "bsb00077415"=>[320461], "bsb00086400"=>[51024571], "bsb00092019"=>[3315], "bsb00071898"=>[319201], "bsb00083814"=>[326125], "bsb00089440"=>[195388], "bsb00039527"=>[252024], "bsb00087653"=>[139220], "bsb00082720"=>[319241], "bsb00082696"=>[184916], "bsb00063835"=>[300780], "bsb00086778"=>[51006365], "bsb00092616"=>[260538], "bsb00090650"=>[313074], "bsb00111855"=>[51037811], "bsb00084746"=>[329669], "bsb00078278"=>[34323], "bsb00086777"=>[51006365], "bsb00082725"=>[313], "bsb00093268"=>[51003740], "bsb00082651"=>[51006381], "bsb00093580"=>[51006632], "bsb00096296"=>[319453], "bsb00094979"=>[51006564], "bsb00092617"=>[260573], "bsb00082717"=>[287], "bsb00087657"=>[139236], "bsb00075337"=>[311267], "bsb00095157"=>[51049893], "bsb00082697"=>[184916], "bsb00090656"=>[117488], "bsb00082718"=>[319247], "bsb00043324"=>[237954], "bsb00087716"=>[191072], "bsb00082698"=>[184916], "bsb00086584"=>[223527], "bsb00094243"=>[318285]}

muscat_rism_ids = YAML::load(File.read("housekeeping/mbs_match/book_ids.yml"))
@mbs_marc = YAML::load(File.read("housekeeping/mbs_match/dnb_marc.yml"))
@people_map = YAML::load(File.read("housekeeping/mbs_match/muscatpeople2dnb.yml"))

def load_mbs_record(mani)
    rec = @mbs_marc[mani]
    xml = Nokogiri::XML(rec)
    marc = MarcSource.new()

    xml.xpath("//marc:record", NAMESPACE).each do |record|
        marc.load_from_xml(record)
    end

    return marc
end

def find_muscat_person(marc)
    t = marc.first_occurance("100", "0")
    return @people_map[t.content.gsub("(DE-588)","")] if t && t.content
    return nil
end

def get_mbs_person(marc)
    t = marc.first_occurance("100", "a")
    return t.content if t && t.content
    return ""
end

not_found = []

File.open("d-mbs_matches.tsv", "w") do |of|
File.open("d-mbs_exact_matches.tsv", "w") do |exm|

CSV::foreach("housekeeping/mbs_match/f-tempo-rism-d-mbs.tsv", col_sep: "\t") do |r|

    
    manifest = r[0]
    mbs_book_id = r[1]
    title = r[2]

    # load the MBS marc
    marc = load_mbs_record(manifest)
    mpid = find_muscat_person(marc)
    mbs_person = get_mbs_person(marc)
    muscat_person = nil

    bsbid = manifest.gsub("https://api.digitale-sammlungen.de/iiif/presentation/v2/", "").gsub("/manifest", "") # yeah

    if mpid
        muscat_person = Person.find(mpid).full_name
    end

    # Use the Muscat normalized name as a preference
    name_from_mbs = muscat_person != nil ? muscat_person : mbs_person

    # we have an exact match!
    if bsb2holding.keys.include?(bsbid)
        bsb2holding[bsbid].each do |holdid|
            src = Holding.find(holdid).source
            data = [mbs_book_id, '', src.id, name_from_mbs, src.composer, 10, src.title, title, manifest]
            exm.write(data.join("\t"))
            exm.write("\n")
        end
        next
    end

    next if !mbs_book_id || mbs_book_id.empty?

    parts = mbs_book_id.split("und")

    #of.write("#{mbs_book_id}\t\t\t#{title}\t#{manifest}")
    #of.write("\n")

    matching_ids = []

    parts.each do |p|
        #puts p.strip.red
        is_b1 = p.include?("RISM B I")
        id = p.strip.gsub("RISM A I,","").gsub("RISM B I,","").gsub("RISM DKL","").gsub("RISM B VI,", "").gsub("RISM B II,", "").strip

        if is_b1
            #puts id.red
            #puts id[4, id.length]
            id = id[0,4] + "|" + id[4, id.length]
            #puts id
        end

        
        not_found << r if !muscat_rism_ids[id] && matching_ids.empty? #&& !(p.include?("RISM DKL") || p.include?("RISM B VI"))

        if muscat_rism_ids[id]
            muscat_rism_ids[id].each do |s|
                matching_ids << s
            end
        end
=begin
        if muscat_rism_ids[id]
            muscat_rism_ids[id].each do |s|
                src = Source.find(s)
                #of.write("\t#{id}\t#{s}\t#{src.title}")
                #of.write("\n")

                ## bigger output
                score = String::Similarity.cosine(title.downcase, src.title.downcase)
                data = [mbs_book_id, id, s, name_from_mbs, src.composer, score, src.title, title, manifest]
                of.write(data.join("\t"))
                of.write("\n")
            end
        else
            #of.write("\t#{id}\tnot_found")
            #of.write("\n")
        end
=end

    end

    matching_ids.sort.uniq.each do |s|
        src = Source.find(s)

        score = String::Similarity.cosine(title.downcase, src.title.downcase)
        data = [mbs_book_id, "", s, name_from_mbs, src.composer, score, src.title, title, manifest]
        of.write(data.join("\t"))
        of.write("\n")
    end

end
end; end

#ap not_found.sort
#puts not_found.count

def rismonlinize(phrase)
    founds = []
    response = RestClient.get("https://rism.online/search?q=#{CGI.escape(phrase)}&fq=material-source-types%3APrint", {accept: :json})

    ro = JSON.parse(response)
    if ro["totalItems"] > 0
        ro["items"].each do |item|
            founds << item["id"]
        end
    end
    return founds
end

File.open("d-mbs_nobueno.tsv", "w") do |of|
    not_found.each do |r|

        manifest = r[0]
        mbs_book_id = r[1]
        title = r[2]
    
        # load the MBS marc
        marc = load_mbs_record(manifest)

        thea = marc.first_occurance("245", "a").content rescue ""
        theb = marc.first_occurance("245", "b").content rescue ""
        thec = marc.first_occurance("245", "c").content rescue ""
        
        found = rismonlinize(thea)
        found = rismonlinize(theb) if found.empty?
        found = rismonlinize(thec) if found.empty?

        of.write([r[0], r[1], found.join(" "), thea, theb, thec].join("\t"))
        of.write("\n")
    end
end